---
name: codex-review
description: Codex CLIでコードレビューを実行し指摘内容を取得・対応 (user)
allowed-tools:
  # ~ is not expanded in allowed-tools patterns (claude-code#14956)
  - Bash(bash /Users/rysk/.claude/skills/codex-review/review.sh *)
  - BashOutput
---

# Codex CLI コードレビュー

Codex CLI の `codex review` を実行し、レビュー結果を取得・整理してユーザーに報告する。

## 入力

`$ARGUMENTS` にベースブランチとオプションフラグが渡される。

- ベースブランチは省略可（デフォルト: main）
- `--bg` フラグ指定でバックグラウンド実行モードに切り替え

例

- `/codex-review` → フォアグラウンド、ベースブランチ main
- `/codex-review develop` → フォアグラウンド、ベースブランチ develop
- `/codex-review --bg` → バックグラウンド、ベースブランチ main
- `/codex-review develop --bg` → バックグラウンド、ベースブランチ develop

## モード判定

`$ARGUMENTS` に `--bg` が含まれるかどうかで実行モードを判定する。
`--bg` を除いた残りの引数をスクリプトに渡す。

- `--bg` なし → フォアグラウンドモード（デフォルト）
- `--bg` あり → バックグラウンドモード

## フォアグラウンドモード（デフォルト）

### 1. レビューの実行

`bash /Users/rysk/.claude/skills/codex-review/review.sh $SCRIPT_ARGS` を実行する。

- `$SCRIPT_ARGS` が空の場合は引数なしで実行（デフォルト: main）
- Bash tool の timeout パラメータは 600000（最大値）を指定する
- スクリプトが非ゼロ終了した場合は、エラー内容をユーザーに報告する
- codex セクションが抽出できない場合、スクリプトは stderr 全体をフォールバック出力する

### 2. 共通分析ステップへ

review.sh の出力を「共通分析ステップ」に従って処理する。

## バックグラウンドモード（--bg）

### 起動フェーズ

#### 1. レビューの開始

`bash /Users/rysk/.claude/skills/codex-review/review.sh $SCRIPT_ARGS` を Bash tool の `run_in_background` パラメータを `true` にして実行する。

- `$SCRIPT_ARGS` が空の場合は引数なしで実行（デフォルト: main）

#### 2. ユーザーへの報告

以下を報告してスキルの実行を終了する。

- バックグラウンドで Codex レビューを開始したこと
- 他のコマンドを実行可能であること
- 完了したら自動的に結果を処理すること（手動確認は `/check-bg`）

### 結果処理フェーズ

以下のいずれかの条件で結果処理フェーズを開始する。

1. ユーザーが結果確認を依頼した場合
2. メッセージに該当バックグラウンドタスクの system-reminder が含まれる場合

条件2の場合はまず BashOutput でステータスを確認し、まだ実行中であればユーザーのメッセージを優先して処理する（結果処理は行わない）。

#### 3. レビュー結果の取得

BashOutput ツールで review.sh の出力を確認する。

- まだ実行中の場合はステータスを報告し、再度確認を依頼するよう案内する
- エラーで終了した場合は、エラー内容をユーザーに報告する
- シェルが見つからない場合（セッション消失）は `$HOME/.cache/claude-bg/codex-review-*.txt` の最新ファイルを読み取る
- codex セクションが抽出できない場合、スクリプトは stderr 全体をフォールバック出力する

#### 4. 共通分析ステップへ

取得した出力を「共通分析ステップ」に従って処理する。

## 共通分析ステップ

### 出力の分割

出力に `---USAGE---` セパレータが含まれる場合、セパレータより前をレビュー結果、セパレータより後の JSON を使用量データとして分離する。

### レビュー結果の分類

レビュー結果を以下のカテゴリに分類する。

- 重大な問題 - バグ、セキュリティリスク、データ損失の可能性
- 改善提案 - パフォーマンス、可読性、保守性の改善
- 軽微な指摘 - スタイル、命名、コメントの改善
- 情報提供 - 質問、確認事項、補足情報

### 構造化レポート

分類した結果を構造化してユーザーに報告する。

- カテゴリごとにグループ化
- 各指摘に対象ファイルと行番号を含める（レビュー結果に記載がある場合）
- 重大な問題がない場合はその旨を明記する

使用量データがある場合、レポート末尾に以下の形式で追加する。

```text
Codex 使用量
- モデル: {model}
- トークン: {total_tokens} (入力: {input_tokens}, キャッシュ: {cached_tokens}, 出力: {output_tokens}, 推論: {reasoning_tokens})
- コスト: ${cost_usd}
- 残量: 5時間枠 {remaining_5h}% / 週間枠 {remaining_weekly}%
```

残量フィールドがない場合はその行を省略する。

使用量データがない場合はこのセクションを省略する。

### 修正提案

重大な問題と改善提案について、修正方針を提示する。

- ユーザーの承認を得てから修正を実施する
- 修正は最小限に留める（指摘された箇所のみ）

### 再レビューの提案

修正を実施した場合、再レビューを提案する。

```text
修正が完了しました。再レビューを実行しますか？ → /codex-review
```
