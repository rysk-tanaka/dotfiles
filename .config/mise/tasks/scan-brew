#!/usr/bin/env bash
#MISE description="Show differences between installed packages and Brewfile"

set -euo pipefail

DOTFILES_PATH="${DOTFILES_PATH:-$(cd "$(dirname "$0")/../../.." && pwd)}"
BREWFILE="${DOTFILES_PATH}/Brewfile"

if ! command -v brew &>/dev/null; then
    echo "Error: Homebrew is not installed" >&2
    exit 1
fi

if ! command -v python3 &>/dev/null; then
    echo "Error: python3 is not installed" >&2
    exit 1
fi

if [ ! -f "$BREWFILE" ]; then
    echo "Error: Brewfile not found at ${BREWFILE}" >&2
    exit 1
fi

echo "Scanning..."
echo ""

# Gather data: Brewfile, installed packages, and package info (3-4 brew commands total)
installed_formulae=$(brew leaves)
installed_casks=$(brew list --cask 2>/dev/null || true)
installed_info=$(brew info --json=v2 --installed 2>/dev/null || echo '{}')

# Identify missing casks for batch lookup
missing_cask_info=""
missing_casks=$(python3 -c "
import sys, json

brewfile = sys.argv[1]
installed_casks_text = sys.argv[2]

bf_casks = set()
with open(brewfile) as f:
    for line in f:
        line = line.strip()
        if line.startswith('cask \"'):
            name = line.split('\"')[1]
            bf_casks.add(name)

installed = set(c for c in installed_casks_text.strip().split('\n') if c)
missing = bf_casks - installed
if missing:
    print('\n'.join(sorted(missing)))
" "$BREWFILE" "$installed_casks")

if [ -n "$missing_casks" ]; then
    # Convert newline-separated list to arguments
    missing_cask_args=()
    while IFS= read -r c; do
        [ -n "$c" ] && missing_cask_args+=("$c")
    done <<< "$missing_casks"
    if [ ${#missing_cask_args[@]} -gt 0 ]; then
        missing_cask_info=$(brew info --json=v2 --cask "${missing_cask_args[@]}" 2>/dev/null || echo '{}')
    fi
fi

# All logic in a single Python call: diff calculation and output
python3 -c "
import json, sys

brewfile_path = sys.argv[1]
installed_formulae_text = sys.argv[2]
installed_casks_text = sys.argv[3]
installed_info_json = sys.argv[4]
missing_cask_info_json = sys.argv[5]

# Parse Brewfile (preserve order)
bf_formulae = []
bf_casks = []
with open(brewfile_path) as f:
    for line in f:
        line = line.strip()
        if line.startswith('brew \"'):
            bf_formulae.append(line.split('\"')[1])
        elif line.startswith('cask \"'):
            bf_casks.append(line.split('\"')[1])

bf_formulae_set = set(bf_formulae)
bf_casks_set = set(bf_casks)

# Parse installed packages
installed_formulae_list = [l for l in installed_formulae_text.strip().split('\n') if l]
installed_casks_list = [l for l in installed_casks_text.strip().split('\n') if l]

# short_name -> full_name mapping for formulae (e.g. 'user/tap/pkg' -> 'pkg')
installed_formulae_short = {}
for leaf in installed_formulae_list:
    short = leaf.rsplit('/', 1)[-1]
    installed_formulae_short[short] = leaf

installed_casks_set = set(installed_casks_list)

# Parse package info
pkg_desc = {}
pkg_auto = {}

try:
    data = json.loads(installed_info_json)
    for f in data.get('formulae', []):
        pkg_desc[f.get('name', '')] = f.get('desc') or '(no description)'
    for c in data.get('casks', []):
        token = c.get('token', '')
        pkg_desc[token] = c.get('desc') or '(no description)'
        if c.get('auto_updates'):
            pkg_auto[token] = 'auto_updates'
except (json.JSONDecodeError, ValueError):
    pass

try:
    mdata = json.loads(missing_cask_info_json) if missing_cask_info_json else {}
    for c in mdata.get('casks', []):
        token = c.get('token', '')
        pkg_desc[token] = c.get('desc') or '(no description)'
        if c.get('auto_updates'):
            pkg_auto[token] = 'auto_updates'
except (json.JSONDecodeError, ValueError):
    pass

# === Installed but not in Brewfile ===
untracked = []
for leaf in installed_formulae_list:
    short = leaf.rsplit('/', 1)[-1]
    if short not in bf_formulae_set:
        desc = pkg_desc.get(short, '(no description)')
        untracked.append(f'  [formula] {short} - {desc}')

for cask in installed_casks_list:
    if cask not in bf_casks_set:
        desc = pkg_desc.get(cask, '(no description)')
        auto = pkg_auto.get(cask, '')
        suffix = f' ({auto})' if auto else ''
        untracked.append(f'  [cask]    {cask} - {desc}{suffix}')

print('=== Installed but not in Brewfile ===')
if untracked:
    for line in untracked:
        print(line)
else:
    print('  (none)')
print()

# === In Brewfile but not installed ===
missing = []
for bf in bf_formulae:
    if bf not in installed_formulae_short:
        missing.append(f'  brew \"{bf}\" (not installed)')

for bf in bf_casks:
    if bf not in installed_casks_set:
        auto = pkg_auto.get(bf, '')
        if auto:
            missing.append(f'  cask \"{bf}\" (auto_updates, managed outside brew)')
        else:
            missing.append(f'  cask \"{bf}\" (not installed)')

print('=== In Brewfile but not installed ===')
if missing:
    for line in missing:
        print(line)
else:
    print('  (none)')
" "$BREWFILE" "$installed_formulae" "$installed_casks" "$installed_info" "$missing_cask_info"
