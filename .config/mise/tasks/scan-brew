#!/usr/bin/env bash
#MISE description="Show differences between installed packages and Brewfile"

set -euo pipefail

DOTFILES_PATH="${DOTFILES_PATH:-$(cd "$(dirname "$0")/../../.." && pwd)}"
BREWFILE="${DOTFILES_PATH}/Brewfile"

if ! command -v brew &>/dev/null; then
    echo "Error: Homebrew is not installed" >&2
    exit 1
fi

if ! command -v python3 &>/dev/null; then
    echo "Error: python3 is not installed" >&2
    exit 1
fi

if [ ! -f "$BREWFILE" ]; then
    echo "Error: Brewfile not found at ${BREWFILE}" >&2
    exit 1
fi

TMPDIR_PATH=$(mktemp -d)
trap 'rm -rf "$TMPDIR_PATH"' EXIT

echo "Scanning..."
echo ""

# brew leaves: failure is fatal (can't diff without formula list)
if ! installed_formulae=$(brew leaves 2>&1); then
    echo "Error: brew leaves failed: ${installed_formulae}" >&2
    exit 1
fi

# brew list --cask: exit 1 when no casks installed is expected
installed_casks=$(brew list --cask 2>/dev/null || true)

# brew info --installed: write to temp file (avoids ARG_MAX, prevents partial JSON concat)
installed_info_file="${TMPDIR_PATH}/installed_info.json"
if ! brew info --json=v2 --installed > "$installed_info_file" 2>/dev/null; then
    echo "Warning: brew info --json=v2 --installed failed, descriptions will be unavailable" >&2
    echo '{}' > "$installed_info_file"
fi

# All logic in a single Python call
python3 -c "
import json, subprocess, sys

brewfile_path = sys.argv[1]
installed_formulae_text = sys.argv[2]
installed_casks_text = sys.argv[3]
installed_info_file = sys.argv[4]

# Parse Brewfile (preserve order)
bf_formulae = []
bf_casks = []
with open(brewfile_path) as bf:
    for line in bf:
        line = line.strip()
        if line.startswith('brew \"'):
            bf_formulae.append(line.split('\"')[1])
        elif line.startswith('cask \"'):
            bf_casks.append(line.split('\"')[1])

bf_formulae_set = set(bf_formulae)
bf_formulae_short_set = {name.rsplit('/', 1)[-1] for name in bf_formulae}
bf_casks_set = set(bf_casks)

# Parse installed packages
installed_formulae_list = [l for l in installed_formulae_text.strip().split('\n') if l]
installed_casks_list = [l for l in installed_casks_text.strip().split('\n') if l]

# short_name -> full_name mapping for formulae (e.g. 'user/tap/pkg' -> 'pkg')
installed_formulae_short = {leaf.rsplit('/', 1)[-1]: leaf for leaf in installed_formulae_list}
installed_casks_set = set(installed_casks_list)

# Parse package info from temp file
pkg_desc = {}
pkg_auto = {}

try:
    with open(installed_info_file) as info_f:
        data = json.load(info_f)
    for formula in data.get('formulae', []):
        pkg_desc[formula.get('name', '')] = formula.get('desc') or '(no description)'
    for cask in data.get('casks', []):
        token = cask.get('token', '')
        pkg_desc[token] = cask.get('desc') or '(no description)'
        if cask.get('auto_updates'):
            pkg_auto[token] = 'auto_updates'
except json.JSONDecodeError as exc:
    print(f'Warning: Failed to parse installed package info: {exc}', file=sys.stderr)

# Fetch info for missing casks (in Brewfile but not installed)
missing_casks = sorted(bf_casks_set - installed_casks_set)
if missing_casks:
    result = subprocess.run(
        ['brew', 'info', '--json=v2', '--cask'] + missing_casks,
        capture_output=True, text=True,
    )
    if result.returncode == 0 and result.stdout.strip():
        try:
            mdata = json.loads(result.stdout)
            for cask in mdata.get('casks', []):
                token = cask.get('token', '')
                pkg_desc[token] = cask.get('desc') or '(no description)'
                if cask.get('auto_updates'):
                    pkg_auto[token] = 'auto_updates'
        except json.JSONDecodeError as exc:
            print(f'Warning: Failed to parse missing cask info: {exc}', file=sys.stderr)
    elif result.returncode != 0:
        print(f'Warning: brew info --cask failed (exit {result.returncode})', file=sys.stderr)

# === Installed but not in Brewfile ===
untracked = []
for leaf in installed_formulae_list:
    short = leaf.rsplit('/', 1)[-1]
    if short not in bf_formulae_short_set:
        desc = pkg_desc.get(short, '(no description)')
        untracked.append(f'  [formula] {short} - {desc}')

for cask_name in installed_casks_list:
    if cask_name not in bf_casks_set:
        desc = pkg_desc.get(cask_name, '(no description)')
        auto = pkg_auto.get(cask_name, '')
        suffix = f' ({auto})' if auto else ''
        untracked.append(f'  [cask]    {cask_name} - {desc}{suffix}')

print('=== Installed but not in Brewfile ===')
if untracked:
    for line in untracked:
        print(line)
else:
    print('  (none)')
print()

# === In Brewfile but not installed ===
# auto_updates casks may be installed outside brew management,
# so they won't appear in 'brew list --cask' but are still present on the system.
missing = []
for name in bf_formulae:
    short = name.rsplit('/', 1)[-1]
    if short not in installed_formulae_short:
        missing.append(f'  brew \"{name}\" (not installed)')

for name in bf_casks:
    if name not in installed_casks_set:
        auto = pkg_auto.get(name, '')
        if auto:
            missing.append(f'  cask \"{name}\" (auto_updates, managed outside brew)')
        else:
            missing.append(f'  cask \"{name}\" (not installed)')

print('=== In Brewfile but not installed ===')
if missing:
    for line in missing:
        print(line)
else:
    print('  (none)')
" "$BREWFILE" "$installed_formulae" "$installed_casks" "$installed_info_file"
