#!/usr/bin/env bash
#MISE description="Show differences between installed packages and Brewfile"

set -euo pipefail

DOTFILES_PATH="${DOTFILES_PATH:-$(cd "$(dirname "$0")/../.." && pwd)}"
BREWFILE="${DOTFILES_PATH}/Brewfile"

if ! command -v brew &>/dev/null; then
    echo "Error: Homebrew is not installed" >&2
    exit 1
fi

if ! command -v python3 &>/dev/null; then
    echo "Error: python3 is not installed" >&2
    exit 1
fi

if [ ! -f "$BREWFILE" ]; then
    echo "Error: Brewfile not found at ${BREWFILE}" >&2
    exit 1
fi

# Parse Brewfile entries
brewfile_formulae=()
brewfile_casks=()
while IFS= read -r line; do
    if [[ "$line" =~ ^brew\ \"([^\"]+)\" ]]; then
        brewfile_formulae+=("${BASH_REMATCH[1]}")
    elif [[ "$line" =~ ^cask\ \"([^\"]+)\" ]]; then
        brewfile_casks+=("${BASH_REMATCH[1]}")
    fi
done < "$BREWFILE"

# Get installed packages (brew leaves excludes dependencies)
installed_formulae=$(brew leaves)
installed_casks=$(brew list --cask)

# Helper: check if value exists in array
in_array() {
    local needle="$1"
    shift
    for item in "$@"; do
        [[ "$item" == "$needle" ]] && return 0
    done
    return 1
}

# Helper: get package info (desc and auto_updates) via JSON API
# Usage: get_pkg_info <name> [--cask]
get_pkg_info() {
    local name="$1"
    shift
    python3 -c "
import json, subprocess, sys
name = sys.argv[1]
cask_flag = sys.argv[2] if len(sys.argv) > 2 else ''
try:
    cmd = ['brew', 'info', '--json=v2']
    if cask_flag == '--cask':
        cmd.append('--cask')
    cmd.append(name)
    result = subprocess.run(cmd, capture_output=True, text=True, timeout=30)
    if result.returncode != 0:
        print('(brew info failed)\t', file=sys.stderr)
        print('(unknown)\t')
        sys.exit(0)
    data = json.loads(result.stdout)
    if cask_flag == '--cask':
        casks = data.get('casks', [])
        if casks:
            desc = casks[0].get('desc') or '(no description)'
            auto = 'auto_updates' if casks[0].get('auto_updates') else ''
            print(f'{desc}\t{auto}')
        else:
            print('(no description)\t')
    else:
        formulae = data.get('formulae', [])
        if formulae:
            desc = formulae[0].get('desc') or '(no description)'
            print(f'{desc}\t')
        else:
            print('(no description)\t')
except json.JSONDecodeError as e:
    print(f'JSON parse error for {name}: {e}', file=sys.stderr)
    print('(parse error)\t')
except subprocess.TimeoutExpired:
    print(f'Timeout fetching info for {name}', file=sys.stderr)
    print('(timeout)\t')
" "$name" "$@"
}

# Helper: print section header once
print_section_header() {
    local header="$1"
    local flag_var="$2"
    if [ "${!flag_var}" = false ]; then
        echo "=== ${header} ==="
        printf -v "${flag_var}" '%s' true
    fi
}

echo "Scanning..."
echo ""

# === Installed but not in Brewfile ===
has_untracked=false

while IFS= read -r leaf; do
    [ -z "$leaf" ] && continue
    short_name="${leaf##*/}"
    if ! in_array "$short_name" "${brewfile_formulae[@]+"${brewfile_formulae[@]}"}"; then
        print_section_header "Installed but not in Brewfile" has_untracked
        desc=$(get_pkg_info "$leaf" | cut -f1)
        echo "  [formula] ${short_name} - ${desc}"
    fi
done <<< "$installed_formulae"

while IFS= read -r cask; do
    [ -z "$cask" ] && continue
    if ! in_array "$cask" "${brewfile_casks[@]+"${brewfile_casks[@]}"}"; then
        print_section_header "Installed but not in Brewfile" has_untracked
        info=$(get_pkg_info "$cask" --cask)
        desc=$(echo "$info" | cut -f1)
        auto=$(echo "$info" | cut -f2)
        suffix=""
        [ -n "$auto" ] && suffix=" (${auto})"
        echo "  [cask]    ${cask} - ${desc}${suffix}"
    fi
done <<< "$installed_casks"

if [ "$has_untracked" = false ]; then
    echo "=== Installed but not in Brewfile ==="
    echo "  (none)"
fi
echo ""

# === In Brewfile but not installed ===
# auto_updates casks may be installed outside brew management,
# so they won't appear in `brew list --cask` but are still present on the system.
has_missing=false

for bf in "${brewfile_formulae[@]+"${brewfile_formulae[@]}"}"; do
    [ -z "$bf" ] && continue
    if ! echo "$installed_formulae" | grep -Fqx "$bf" && ! echo "$installed_formulae" | grep -q "/${bf}$"; then
        print_section_header "In Brewfile but not installed" has_missing
        echo "  brew \"${bf}\" (not installed)"
    fi
done

for bf in "${brewfile_casks[@]+"${brewfile_casks[@]}"}"; do
    [ -z "$bf" ] && continue
    if ! echo "$installed_casks" | grep -Fqx "$bf"; then
        print_section_header "In Brewfile but not installed" has_missing
        info=$(get_pkg_info "$bf" --cask)
        auto=$(echo "$info" | cut -f2)
        if [ -n "$auto" ]; then
            echo "  cask \"${bf}\" (auto_updates, managed outside brew)"
        else
            echo "  cask \"${bf}\" (not installed)"
        fi
    fi
done

if [ "$has_missing" = false ]; then
    echo "=== In Brewfile but not installed ==="
    echo "  (none)"
fi
